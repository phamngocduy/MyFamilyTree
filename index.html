<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My Family Tree</title>
    <link href="packages/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="packages/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="packages/vue/dist/vue.global.prod.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="spiner bg-white opacity-50 float-start position-absolute start-0 end-0 top-0 bottom-0" style="cursor:wait;z-index:2000;">
    </div>
    <div class="d-flex flex-column col-lg-8 mx-auto p-3 py-md-5" style="min-height:100vh;">
        <header class="d-flex justify-content-between pb-3 mb-5 border-bottom">
            <a href="#" class="d-flex align-items-center text-dark text-decoration-none">
                <img src="packages/bootstrap-icons/icons/people.svg" width="32" height="32">
                <span class="fs-4 ms-2"><small class="text-body-secondary"><em>my</em></small> <strong>Family</strong> <mark>Tree</mark></span>
                <div class="spiner spinner-border text-info ms-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </a>
            <div id="user-info" class="d-flex">
                <div class="dropdown">
                    <div type="button" data-bs-toggle="dropdown">
                        <img id="user-photo" class="img-thumbnail" style="max-height:36px;display:none;">
                        <div id="user-name"></div>
                        <div id="user-email"></div>
                        <div id="user-phone"></div>
                    </div>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="javascript:signOut()">Sign Out</a></li>
                    </ul>
                </div>
                <button id="sign-out" class="btn btn-light" onclick="signOut()" style="display:none;">Sign Out</button>
            </div>
        </header>
        <main id="app">
            <ul class="list-group">
                <a href="#" class="list-group-item list-group-item-action">
                    Thêm cha mẹ
                </a>
                <div class="list-group-item ps-5">
                    <ul class="list-group">
                        <a href="#" class="list-group-item list-group-item-action active">
                            <span>{{member.fullname}}</span>&nbsp;
                            <img src="packages/bootstrap-icons/icons/pencil.svg" onclick="editMember()" data-bs-toggle="modal" data-bs-target="#modal">
                        </a>
                        <div class="list-group-item ps-5">
                            <ul class="list-group">
                                <a href="#" class="list-group-item list-group-item-action">Thêm con cái</a>
                            </ul>
                        </div>
                        <a href="#" class="list-group-item list-group-item-action">Thêm anh em</a>
                    </ul>
                </div>
                <a href="#" class="list-group-item list-group-item-action">Thêm bà con</a>
            </ul>
        </main>
        <div class="modal fade" id="modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="form-floating">
                            <input type="text" :value="member.fullname" class="form-control" placeholder="">
                            <label>Họ tên đầy đủ</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" @click="save" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="pt-5 my-5 text-muted border-top mt-auto">
            Created by <em><mark type="button">Duy_abu</mark></em> &middot; &copy; 2024
        </footer>
      </div>
</body>
<script type="module">
    async function loadModules() {
        const {initializeApp} = await importFirebase('app');
        const {getAuth, onAuthStateChanged, signOut} = await importFirebase('auth');
        const {getFirestore, collection, addDoc, doc, getDoc, getDocs, query, where} = await importFirebase('firestore');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        onAuthStateChanged(auth, (user) => {
            if (user) window.user = user;
            else window.location = './login.html';
            dispatchEvent(new CustomEvent('user'));
            window.signOut = () => abide(signOut(auth));
        })

        const db = getFirestore(app);
        db.addDoc = async function(group, json) {
            return await addDoc(collection(db, group), json);
        }
        db.getDoc = async function(group, id) {
            return await getDoc(doc(db, group, id));
        }
        db.getDocs = async function(group, field, operator, value) {
            return await getDocs(query(collection(db, group), where(field, operator, value)));
        }
        window.db = db
    }
    window.addEventListener('load', async function() {
        //loadModules().then(() => dispatchEvent(new CustomEvent('init')));
        abide(loadModules(), () => dispatchEvent(new CustomEvent('init')));
    });
</script>
<script>
    function blockUI(state) {
        Array.from(document.getElementsByClassName('spiner')).forEach((spiner) => {
            spiner.style.display = state ? 'block' : 'none';
        });
    }
    function abide(promise, callback) {
        blockUI(true);
        promise.then((value) => {
            if (callback)
                callback(value)
        }).catch((error) => {
            console.error(error);
            alert(error.message);
        }).finally(() => blockUI(false));
    }
    async function loadMember() {
        const query = new URL(window.location).searchParams.get('q');
        if (query) {
            member = await window.db.getDoc('members', query);
            window.member = {id: member.id, ...member.data()};
        } else {
            const members = await window.db.getDocs('members', 'userid', '==', window.user.uid);
            if (members.size) {
                window.location = `?q=${members.docs[0].id}`;
            } else {
                const docRef = await db.addDoc('members', {
                    userid: user.uid,
                    fullname: user.displayName ?? 'Anonymous'
                });
                window.location = `?q=${docRef.id}`;
            }
        }
    }
</script>
<script>
    window.addEventListener('init', function() {
        const {createApp} = Vue;
        window.app = createApp({
            data() {
                return {
                    member: {}
                }
            }
        }).mount('#app');
        blockUI(false);
    });

    function editMember() {
        const {createApp} = Vue;
        createApp({
            data() {
                return {
                    member: window.member
                }
            },
            methods: {
                save() {
                    console.log(this.member)
                }
            }
        }).mount('#modal');
    }

    window.addEventListener('user', function() {
        if (window.user.photoURL) {
            document.getElementById('user-photo').style.display = 'block';
            document.getElementById('user-photo').src = window.user.photoURL;
        } else if (window.user.displayName)
            document.getElementById('user-name').textContent = window.user.displayName;
        else if (window.user.email)
            document.getElementById('user-email').textContent = window.user.email;
        else if (window.user.phoneNumber)
            document.getElementById('user-phone').textContent = window.user.phoneNumber;
        else document.getElementById('sign-out').style.display = 'block';

        abide(loadMember(), () => {
            window.app.member = window.member;
        });
    });
</script>
</html>