<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My Family Tree</title>
    <link href="packages/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="packages/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="packages/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="packages/vue/dist/vue.global.prod.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div id="blocker" class="align-items-center text-center bg-white opacity-100 float-start position-absolute start-0 end-0 top-0 bottom-0" style="cursor:wait;display:flex;z-index:2000;">
        <div style="width:100%;">
            <div class="spinner-grow text-primary" role="status"></div>
            <div class="spinner-grow text-info" role="status"></div>
            <div class="spinner-grow text-light" role="status"></div>
        </div>
    </div>
    <div class="d-flex flex-column col-lg-8 mx-auto p-3 py-md-5" style="min-height:100vh;">
        <header class="d-flex justify-content-between pb-3 mb-5 border-bottom">
            <a href="#" class="d-flex align-items-center text-dark text-decoration-none">
                <i class="bi-people fs-1 text-success"></i>
                <span class="fs-4 ms-2"><small class="text-body-secondary"><em>my</em></small> <strong>Family</strong> <mark class="font-monospace">Tree</mark></span>
                <div id="loader" class="spinner-border text-primary ms-3" role="status"></div>
            </a>
            <div id="user-info" class="d-flex">
                <div class="dropdown">
                    <div type="button" data-bs-toggle="dropdown">
                        <img id="user-photo" class="img-thumbnail" style="max-height:36px;display:none;">
                        <div id="user-name"></div>
                        <div id="user-email"></div>
                        <div id="user-phone"></div>
                    </div>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="signOut()" class="dropdown-item">Sign Out</a></li>
                    </ul>
                </div>
                <button id="sign-out" onclick="signOut()" class="btn btn-light" style="display:none;">Sign Out</button>
            </div>
        </header>
        <main id="app">
            <ul class="list-group">
                <a href="#" class="list-group-item list-group-item-action">
                    <img src="packages/bootstrap-icons/icons/person-add.svg" width="24px" height="24px">
                </a>
                <div class="list-group-item ps-5">
                    <ul class="list-group">
                        <a href="#" v-for="member in family.children" class="list-group-item list-group-item-action active">
                            <span>{{member.details.fullname}}&nbsp;</span>
                            <i type="button" @click="editMember(member.details)" class="bi-pencil text-warning" data-bs-toggle="modal" data-bs-target="#modal"></i>
                            <span>&nbsp; – &nbsp;</span>
                            <i type="button" v-bind:onclick="`addSpouse('${family.member.id}')`" class="bi-person-add fs-4" data-bs-toggle="modal" data-bs-target="#modal" style="vertical-align:sub;" v-if="!member.family || !member.family.spouse"></i>
                            <span v-if="member.family && member.family.spouse">
                                <span v-bind:onclick="`window.location.assign('?q=${member.family.spouse.id}')`">{{member.family.spouse.details.fullname}}&nbsp;</span>
                                <i type="button" @click="editMember(member.family.spouse.details)" class="bi-pencil text-warning" data-bs-toggle="modal" data-bs-target="#modal"></i>
                            </span>
                            <button id="showModal" data-bs-toggle="modal" data-bs-target="#modal">Modal</button>
                        </a>
                        <div class="list-group-item ps-5">
                            <ul class="list-group">
                                <a href="#" class="list-group-item list-group-item-action">
                                    <i type="button" v-bind:onclick="`addChild('${family.member.id}')`" class="bi-person-add fs-4" data-bs-toggle="modal" data-bs-target="#modal"></i>
                                </a>
                            </ul>
                        </div>
                        <a href="#" class="list-group-item list-group-item-action">
                            <img src="packages/bootstrap-icons/icons/person-add.svg" width="24px" height="24px">
                        </a>
                    </ul>
                </div>
                <a href="#" class="list-group-item list-group-item-action">
                    <img src="packages/bootstrap-icons/icons/person-add.svg" width="24px" height="24px">
                </a>
            </ul>
        </main>
        <div class="modal fade" id="modal" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <form id="member" class="row g-2">
                            <div class="col-8">
                                <div class="form-floating">
                                    <input type="text" v-model.trim="member.fullname" class="form-control" placeholder="" required>
                                    <label>Họ và tên</label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-floating">
                                    <input type="text" v-model.trim="member.nickname" class="form-control" placeholder="">
                                    <label>Tên gọi khác</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <input type="tel" v-model.trim="member.phone" class="form-control" placeholder="Số điện thoại">
                            </div>
                            <div class="col-6">
                                <input type="email" v-model.trim="member.email" class="form-control" placeholder="Địa chỉ email">
                            </div>
                            <div class="col-6">
                                <div class="input-group">
                                    <span class="input-group-text">Sinh năm</span>
                                    <input type="text" v-model.trim="member.birthday" class="form-control" placeholder="ngày/tháng/năm" :pattern="DATE_PATTERN">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group">
                                    <span class="input-group-text">tại</span>
                                    <input type="text" v-model.trim="member.birthplace" class="form-control" placeholder="địa phương...">
                                    <span>&nbsp;</span>
                                    <i data-bs-toggle="collapse" data-bs-target="#collapseDeath"
                                    type="button" class="bi-calendar2-plus float-end text-primary"></i>
                                </div>
                            </div>
                            <div class="col-6 collapse" id="collapseDeath">
                                <div class="input-group">
                                    <span class="input-group-text">Mất ngày</span>
                                    <input type="text" v-model.trim="member.deathday" class="form-control" :pattern="DATE_PATTERN">
                                </div>
                            </div>
                            <div class="col-6 collapse" id="collapseDeath">
                                <div class="input-group">
                                    <span class="input-group-text">tại</span>
                                    <input type="text" v-model.trim="member.deathplace" class="form-control">
                                    <span>&nbsp;</span>
                                    <input type="checkbox" v-model="member.deathlunar" id="btn-lunar" class="btn-check" checked autocomplete="off">
                                    <label class="btn btn-outline-warning" for="btn-lunar" data-bs-toggle="tooltip" title="Âm lịch">ÂL</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <input type="text" v-model.trim="member.address" class="form-control" placeholder="Nơi ở hiện tại">
                            </div>
                            <button type="submit" onclick="saveMember(event)" class="d-none">Save Changes</button>
                        </form>
                        <form id="history" class="row g-2">
                            <div class="col-4">
                                <label class="form-label">Tiểu sử</label>
                                <input type="text" v-model.trim="event_date" class="form-control" placeholder="Thời gian" :pattern="DATE_PATTERN" required>
                            </div>
                            <div class="col-8">
                                <label class="form-label float-end" type="button">
                                    <i type="button" class="bi-x-circle text-warning" @click="clsEvent()" v-if="event_date || event_details"></i>
                                    <span>&nbsp;&nbsp;&nbsp;</span>
                                    <i type="button" class="bi-save text-primary" @click="addEvent()" v-if="event_date && event_details"></i>
                                </label>
                                <input type="text" v-model.trim="event_details" v-on:keyup.enter="addEvent()" class="form-control" placeholder="Thông tin/sự kiện/học tập/làm việc..." required>
                            </div>
                        </form>
                        <table class="table table-hover table-stripe">
                            <tbody>
                                <tr v-if="member.birthday">
                                    <td>{{member.birthday}}</td>
                                    <td>
                                        Sinh năm {{toCanChi(member.birthday)}}<span v-if="!member.birthplace">.</span>
                                        <span v-if="member.birthplace"> tại {{member.birthplace}}.</span>
                                    </td>
                                </tr>
                                <tr v-for="(event, id) in sortHistory">
                                    <td>{{event.date}}
                                    </td>
                                    <td>{{event.details}}
                                        <i type="button" @click="delEvent(event)" class="bi-x-lg float-end text-danger"></i>
                                    </td>
                                </tr>
                                <tr v-if="member.deathday">
                                    <td>{{member.deathday}}</td>
                                    <td>
                                        Mất ngày {{member.deathday}}<span v-if="!member.deathplace">.</span>
                                        <span v-if="member.deathplace"> tại {{member.deathplace}}.</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" onclick="saveMember()" class="btn btn-primary">Lưu thông tin</button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="pt-5 my-5 text-muted border-top mt-auto">
            Created by <em><mark type="button">Duy_abu</mark></em> &middot; &copy; 2024
        </footer>
      </div>
</body>
<script type="module">
    async function loadFirebase() {
        const {initializeApp} = await importFirebase('app');
        const {getAuth, onAuthStateChanged, signOut} = await importFirebase('auth');
        const {getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, where, writeBatch} = await importFirebase('firestore');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.user = user;
                dispatchEvent(new CustomEvent('user'));
                window.signOut = () => invoke(signOut(auth));
            }
            else window.location = 'login.html';
        });

        const db = getFirestore(app);
        db.newDoc = async function(group) {
            return await doc(collection(db, group));
        }
        db.addDoc = async function(group, json) {
            return await addDoc(collection(db, group), json);
        }
        db.setDoc = async function(group, id, json) {
            return await setDoc(doc(db, group, id), json);
        }
        db.getDoc = async function(group, id) {
            return await getDoc(doc(db, group, id));
        }
        db.getDocs = async function(group, field, operator, value) {
            return await getDocs(query(collection(db, group), where(field, operator, value)));
        }
        db.batch = async function() {
            return await writeBatch(db);
        }
        window.db = db;
    }

    addEventListener('load', () =>
        invoke(loadFirebase(), () =>
            dispatchEvent(new CustomEvent('init')))
    );
</script>
<script>
    Array.prototype.findById = function(id) {
        return this.find((element) => element.id == id);
    }
    Array.prototype.remove = function(element) {
        return this.splice(this.indexOf(element), 1);
    }

    function blockUI(block) {
        document.getElementById('blocker').style.display = block ? 'flex' : 'none';
    }
    function loadUI(block) {
        document.getElementById('loader').style.display = block ? 'block' : 'none';
    }

    function invoke(promise, callback, blocker=blockUI) {
        blocker(true);
        promise.then((value) => {
            if (callback) callback(value);
        }).catch((error) => {
            console.error(error);
            alert(error.message);
        }).finally(() => blocker(false));
    }
    function revoke(promise, callback) {
        invoke(promise, callback, blocker=loadUI);
    }

    async function initMember() {
        window.member_id = new URL(location).searchParams.get('q');
        if (member_id != undefined) {
            const member = await loadMember(member_id);
            if (member != undefined)
                return {
                    id: member_id,
                    details: member
                }
            else location.replace('.');
        } else {
            const members = await db.getDocs('members', 'userid', 'array-contains', user.uid);
            if (members.size > 0) {
                location.replace(`?q=${members.docs[0].id}`);
            } else {
                const member = await db.addDoc('members', {
                    userid: [user.uid],
                    email: user.email,
                    phone: user.phoneNumber,
                    fullname: user.displayName ?? 'Anonymous'
                });
                location.replace(`?q=${member.id}`);
            }
        }
    }

    async function loadMember(member_id) {
        const member = await db.getDoc('members', member_id);
        return member.exists() ? member.data() : undefined;
    }

    async function loadFamily(member_id) {
        const relations = await db.getDocs('relations', 'parents', 'array-contains', member_id);
        const family = {children: []};
        if (relations.size > 0) {
            const relation = relations.docs[0].data();
            relation.parents.remove(member_id);
            if (relation.parents.length > 0) {
                const spouse = await loadMember(relation.parents[0]);
                family.spouse = {
                    id: relation.parents[0],
                    details: spouse
                }
            }
            for (const child_id of relation.children) {
                const child = await loadMember(child_id)
                family.children.push({
                    id: child_id,
                    details: child
                });
            }
        };
        return family;
    }

    async function loadSpouses(member_id) {
        const relations = await db.getDocs('relations', 'parents', 'array-contains', member_id);
        const spouses = [];
        if (relations.size > 0) {
            for (const spouse_id of relations.docs[0].data().parents) {
                if (spouse_id != member_id) {
                    const spouse = await loadMember(spouse_id);
                    if (spouse) spouses.push({id: spouse_id, details: spouse});
                }
            }
        }
        return spouses;
    }
</script>
<script>
    window.addEventListener('init', function() {
        const {createApp} = Vue;
        window.xApp = createApp({
            data() {
                return {
                    family: {
                        member: {}
                    }
                };
            },
            methods: {
                editMember(member) {
                    window.eApp.member = member;
                    window.eApp.type = undefined;
                }
            }
        }).mount('main');

        window.eApp = createApp({
            data() {
                return {
                    member: {
                        history: [
                            {date: '2024', details: 'My Family Tree'}
                        ]
                    },
                    event_date: undefined,
                    event_details: undefined,
                    DATE_PATTERN: DATE_PATTERN
                };
            },
            computed: {
                sortHistory() {
                    if (this.member.history == undefined)
                        this.member.history = [];
                    return this.member.history.sort(
                        (a, b) => this.parseDate(a.date) - this.parseDate(b.date)
                    );
                }

            },
            methods: {
                addEvent() {
                    const history = document.forms['history'];
                    if (history.reportValidity()) {
                        this.member.history.push({
                            date: this.event_date,
                            details: this.event_details
                        });
                        this.clsEvent();
                    }
                },
                delEvent(event) {
                    this.member.history.splice(this.member.history.indexOf(event), 1);
                },
                clsEvent() {
                    this.event_date = this.event_details = undefined;
                },
                toCanChi(ddmmyyyy) {
                    const CAN = ['Canh', 'Tân', 'Nhâm', 'Quý', 'Giáp', 'Ất', 'Bính', 'Đinh', 'Mậu', 'Kỷ'];
                    const CHI = ['Thân', 'Dậu', 'Tuất', 'Hợi', 'Tý', 'Sửu', 'Dần', 'Mẹo', 'Thìn', 'Tỵ', 'Ngọ', 'Mùi'];
                    try {
                        const year = parseInt(ddmmyyyy.split('/').pop());
                        return CAN[year % 10] + ' ' + CHI[year % 12];
                    } catch (e) { }
                },
                parseDate(ddmmyyyy) {
                    return Date.parse(ddmmyyyy.split('/').reverse().join('-'));
                }
            }
        }).mount('#modal');
        //document.getElementById('showModal').click()
    });

    function saveMember(event) {
        if (event) event.preventDefault();
        if (document.forms['member'].reportValidity()) {
            const modal = bootstrap.Modal.getInstance('#modal');
            switch (window.eApp.type) {
                case 'CHILD':
                    await2(setChild(window.eApp.member), () => {
                        if (window.xApp.family.children)
                            window.xApp.family.children.push(window.eApp.member);
                        else window.xApp.family.children = [window.eApp.member];
                    });
                    break;
                case 'SPOUSE':
                    await2(setSpouse(window.eApp.member),
                    () => window.xApp.family.spouses = [window.eApp.member]);
                    break;
                default:
                    await2(db.setDoc('members', window.eApp.member),
                    () => window.xApp.family.member = window.eApp.member);
            }
            modal.hide();
        }
    }

    function addSpouse(spouse_id) {
        window.eApp.member = {
            id: spouse_id
        };
        window.eApp.type = 'SPOUSE';
    }
    async function setSpouse(spouse) {
        const batch = await window.db.batch();
        const spouse_id = window.db.popId(spouse);
        const member = await window.db.newDoc('members');
        const relation = await window.db.newDoc('relations');
        await batch.set(member, spouse);
        await batch.set(relation, {
            parents: [spouse_id, member.id],
            children: []
        });
        await batch.commit();
    }
    function addChild(parent_id) {
        window.eApp.member = {
            id: parent_id
        };
        window.eApp.type = 'CHILD';
    }
    async function setChild(child) {
        const batch = await window.db.batch();
        const parent_id = window.db.popId(child);
        const member = await window.db.newDoc('members');
        const relations = await window.db.getDocs('relations', 'parents', 'array-contains', child_id);
        const relation = relations.size ? relations.docs[0] : await window.db.newDoc('relations');
        const relation_data = relation.data();
        if (relations.size) {
            relation_data.children.push(member.id);
        } else {
            relation_data = {
                parents: [parent_id],
                children: [member.id]
            };
        }
        await batch.set(member, child);
        await batch.set(relation, relation_data);
        await batch.commit();
    }

    addEventListener('user', function() {
        if (user.photoURL) {
            document.getElementById('user-photo').style.display = 'block';
            document.getElementById('user-photo').src = user.photoURL;
        } else if (user.displayName)
            document.getElementById('user-name').textContent = user.displayName;
        else if (user.email)
            document.getElementById('user-email').textContent = user.email;
        else if (user.phoneNumber)
            document.getElementById('user-phone').textContent = user.phoneNumber;
        else document.getElementById('sign-out').style.display = 'block';

        revoke(initMember(), (member) => {
            if (!member) return false;
            xApp.family.children = [member];
            revoke(loadFamily(member.id), (family) =>
                xApp.family.children.findById(member.id).family = family);
        });
    });
</script>
</html>